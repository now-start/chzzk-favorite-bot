<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>호감도 목록</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
  <style>
    body {
      padding-top: 56px;
    }

    .container {
      margin-top: 20px;
    }

    .form-inline .form-control {
      width: auto;
    }

    .table-hover tbody tr:hover {
      background-color: #f5f5f5;
    }

    .thead-spring-admin {
      background-color: #00b19d; /* Spring Boot Admin color */
      color: #fff; /* White text for contrast */
    }

    .btn-custom {
      width: 100px; /* Set a fixed width for buttons */
      height: 38px; /* Set a fixed height for buttons */
    }

    .history-dropdown {
      display: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="container">
  <h1 class="mb-4">호감도 목록</h1>
  <div th:if="${errorMessage}" class="alert alert-danger" th:text="${errorMessage}"></div>

  <!-- ID 검색 폼 -->
  <form th:action="@{/favorite/list}" method="get" class="form-inline mb-3">
    <div class="form-group mr-2">
      <label for="searchId" class="sr-only">Search by ID:</label>
      <input type="text" id="searchId" name="searchId" th:value="${nickName}" class="form-control" placeholder="Enter nickName">
    </div>
    <button type="submit" class="btn btn-primary btn-custom">Search</button>
  </form>

  <!-- 데이터 리스트 -->
  <table class="table table-striped table-hover table-bordered">
    <thead class="thead-spring-admin">
    <tr>
      <th style="width: 7%;">순위</th>
      <th style="width: 20%;">닉네임</th>
      <th style="width: 10%;">호감도</th>
      <th style="">사유</th>
      <th style="width: 7%;">날짜</th>
      <th style="width: 7%;">버튼</th>
    </tr>
    </thead>
    <tbody>
    <div th:if="${favoriteList != null}">
      <tr th:each="favoriteEntity, iterStat : ${favoriteList.content}">
        <td th:text="${favoriteList.number * favoriteList.size + iterStat.index + 1}">10</td>
        <td>
          <span th:text="${favoriteEntity.nickName}" class="nickname" th:data-user-id="${favoriteEntity.userId}">테스트</span>
        </td>
        <td>
          <span th:text="${favoriteEntity.favorite}">12200</span>
        </td>
        <td>
          <span th:text="${favoriteEntity.histories.size() > 0 ? favoriteEntity.histories[0].history : '최초 입력'}">최초 입력</span>
        </td>
        <td>
          <span th:text="${#temporals.format(favoriteEntity.modifyDate, 'M/d')}">10/08</span>
        </td>
        <td>
          <form th:action="@{/favorite/delete}" method="post" class="d-inline deleteForm">
            <input type="hidden" name="userId" th:value="${favoriteEntity.userId}">
            <button type="submit" class="btn btn-danger btn-sm btn-custom">삭제</button>
          </form>
        </td>
      </tr>
    </div>
    <!-- 데이터 추가 폼 -->
    <tr>
      <form th:action="@{/favorite/add}" method="post" class="form-inline">
        <td>
          <input type="text" id="userId" name="userId" class="form-control" placeholder="ID" required>
        </td>
        <td>
          <input type="text" id="nickName" name="nickName" class="form-control" placeholder="닉네임" required>
        </td>
        <td>
          <input type="number" id="favorite" name="favorite" class="form-control" placeholder="0" required>
        </td>
        <td>
          <input type="text" id="history" name="history" class="form-control" placeholder="최초 입력" required>
        </td>
        <td>
          <span th:text="${#temporals.format(T(java.time.LocalDate).now(), 'M/d')}"></span>
        </td>
        <td>
          <button type="submit" class="btn btn-success btn-custom">변경</button>
        </td>
      </form>
    </tr>
    </tbody>
  </table>

  <!-- 페이지 네비게이션 -->
  <div th:if="${favoriteList != null}">
    <nav th:if="${favoriteList.totalPages > 1}">
      <ul class="pagination justify-content-center">
        <li th:classappend="${favoriteList.number == 0} ? 'disabled'" class="page-item">
          <a th:href="@{/favorite/list(page=${favoriteList.number - 1})}" class="page-link" aria-label="Previous">
            <span aria-hidden="true">&laquo;</span>
          </a>
        </li>
        <li th:each="i : ${#numbers.sequence(0, favoriteList.totalPages - 1)}" th:classappend="${i == favoriteList.number} ? 'active'" class="page-item">
          <a th:href="@{/favorite/list(page=${i})}" class="page-link" th:text="${i + 1}"></a>
        </li>
        <li th:classappend="${favoriteList.number == favoriteList.totalPages - 1} ? 'disabled'" class="page-item">
          <a th:href="@{/favorite/list(page=${favoriteList.number + 1})}" class="page-link" aria-label="Next">
            <span aria-hidden="true">&raquo;</span>
          </a>
        </li>
      </ul>
    </nav>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
<script>
  document.addEventListener('keydown', function (event) {
    if (event.key === 'F5' || (event.ctrlKey && event.key === 'r') || (event.metaKey && event.key === 'r')) {
      event.preventDefault();
    }
  });

  document.addEventListener('DOMContentLoaded', function () {
    let lastOpenedRow = null;

    document.querySelectorAll('tbody tr').forEach(function (row) {
      row.addEventListener('click', function () {
        var nicknameElement = row.querySelector('.nickname');
        if (!nicknameElement) return; // Skip if no nickname element found

        var userId = nicknameElement.getAttribute('data-user-id');
        console.log('User ID:', userId); // Debugging log

        // Hide previously opened history rows
        if (lastOpenedRow && lastOpenedRow !== row) {
          var nextRow = lastOpenedRow.nextSibling;
          while (nextRow && nextRow.classList.contains('history-row')) {
            nextRow.style.display = 'none';
            nextRow = nextRow.nextSibling;
          }
        }

        if (row.nextSibling && row.nextSibling.classList.contains('history-row') && row.nextSibling.style.display !== 'none') {
          // Toggle visibility if history rows already exist and are visible
          var nextRow = row.nextSibling;
          while (nextRow && nextRow.classList.contains('history-row')) {
            nextRow.style.display = 'none';
            nextRow = nextRow.nextSibling;
          }
        } else {
          // Fetch and display history rows if they don't exist or are hidden
          $.ajax({
            url: '/favorite/history/' + userId,
            method: 'GET',
            success: function (data) {
              console.log('Fetched data:', data); // Debugging log
              data.forEach(function (item) {
                console.log('Fetched data:', item); // Debugging log
                var newRow = document.createElement('tr');
                newRow.classList.add('history-row');
                newRow.innerHTML = `
                <td></td>
                <td></td>
                <td><span>${item.favorite}</span></td>
                <td><span>${item.history}</span></td>
                <td><span>${(new Date(item.modifyDate)).getMonth() + 1}/${(new Date(item.modifyDate)).getDate()}</span></td>
                <td></td>
              `;
                row.parentNode.insertBefore(newRow, row.nextSibling);
              });
            },
            error: function (error) {
              console.error('Error fetching history:', error);
            }
          });
        }

        lastOpenedRow = row;
      });
    });
  });
</script>
</body>
</html>